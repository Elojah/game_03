syntax                                      = "proto3";

package ability;

option (gogoproto.testgen_all)              = true;
option (gogoproto.benchgen_all)             = true;
option (gogoproto.populate_all)             = true;
option (gogoproto.goproto_getters_all)      = false;
option (gogoproto.goproto_stringer_all)     = false;
option (gogoproto.goproto_unrecognized_all) = false;
option (gogoproto.goproto_enum_prefix_all)  = false;
option (gogoproto.goproto_registration)     = true;

import "github.com/gogo/protobuf/gogoproto/gogo.proto";

import "github.com/elojah/game_03/pkg/geometry/geometry.proto";

enum Stat {
	NoneStat                                   = 0;
	Damage                                     = 1;
	Defense                                    = 2;
	MoveSpeed                                  = 4;
	CastSpeed                                  = 5;
	CooldownReduction                          = 6;
	HP                                         = 7;
	MP                                         = 8;
	MaxHP                                      = 9;
	MaxMP                                      = 10;

	// only used in drain
	DamageReceived                             = 11;
}

enum Target {
	NoneTarget                                 = 0;
	Self                                       = 1;
	Foe                                        = 3;
	ClosestSelf                                = 4;
	ClosestFoe                                 = 5;

	// geometry aoe
	Rect                                       = 6;
	Circle                                     = 7;
}

message Modifier {
	// Add cast time
	int64 CastTime                             = 1;
	// Add mana cost
	int64 ManaCost                             = 2;
	// Add cooldown
	int64 Cooldown                             = 3;
	// Change affected stat
	Stat Stat                                  = 4;
	// Add amount
	Amount Amount                              = 5;
	// Change drained stat
	Amount Drain                               = 6;
	// Change duration
	int64 Duration                             = 7;
	// Add Delay
	int64 Delay                                = 8;
	// Change tick rate
	int64 Repeat                               = 9;
	// Add stacks
	int64 Stacks                               = 10;
}

// Amount used for ability
message Amount {
	Target Target                              = 1;

	int64 Direct                               = 2;

	int64 Stat                                 = 3;
	int64 Percentage                           = 4;

    bytes EffectID                             = 5 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];
}

enum Operator {
	NoneOperator                               = 0;
	Equal                                      = 1;
	NotEqual                                   = 2;
	Greater                                    = 3;
	Lesser                                     = 4;
}

message Trigger {
	Operator Operator                          = 1;
	Amount Amount                              = 2;
	Amount Treshold                            = 3;
	// only for effect or stat HP/MP
	bool ConsumeTreshold                       = 4;

	repeated Modifier Modifiers                = 5 [(gogoproto.nullable) = false];

	// logical AND
	Trigger Trigger                            = 6;
}

message StackRules {
	int64 Stacks                               = 1;
	int64 MaxStacks                            = 2;
	// if true, set to max duration
	// if false, duration are added
	bool MaxDuration                           = 3;
}

message Effect {
    bytes ID                                   = 1 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];

	// if HP/MP, duration is ignored
	Stat Stat                                  = 2;

	// Movement effect (TP or push back)
	geometry.Vec2 Position                     = 3;
	geometry.Vec2 Force                        = 4; // Teleport if force == 0/0

	Amount Amount                              = 5;
	Amount Drain                               = 6;
	// drain is duplicate for all targets
	repeated Target DrainTargets               = 7;

	// stack rules
	// if duration 0 or ignored, overtime effects ignored too
	int64 Duration                             = 8;
	bytes Icon                                 = 9 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];

	StackRules StackRules                      = 10 [(gogoproto.nullable) = false];

	// Tick only if duration > 0 and not ignored
	int64 Delay                                = 11; // after ms
	int64 Repeat                               = 12; // each ms

	// logical OR
	repeated Trigger Triggers                  = 13 [(gogoproto.nullable) = false];
}

message Component {
    bytes ID                                   = 1 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];

	repeated Target Targets                    = 1;
	repeated Effect Effects                    = 2 [(gogoproto.nullable) = false];
}

message Ability {
    bytes ID                                   = 1 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];
	string Name                                = 2;

	bytes Icon                                 = 3 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];
	bytes Animation                            = 4 [(gogoproto.customtype) = "github.com/elojah/game_03/pkg/ulid.ID", (gogoproto.nullable) = false];

	int64 CastTime                             = 5;
	int64 ManaCost                             = 6;
	int64 Cooldown                             = 7;

	repeated Component Components              = 8 [(gogoproto.nullable) = false];
}
